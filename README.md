# Kodi медиа-центр на основе Orange Pi 4

![img](http://thecatapi.com/api/images/get?type=gif)

# **ПРЕДИСЛОВИЕ**

**Данный репозиторий разделён на 3 ветки в целях экономии свободного места и трафика при клонировании основного репозитория. Образы и изображения находятся в отдельных ветках, поэтому вы их не найдёте в ветке master.**

Данное руководство содержит готовый образ медиа-центра для Orange Pi 4 (на Orange Pi 4b не тестировал, но единственное отличие между ними - дополнительный ИИ модуль, так что всё должно работать, кроме него).

Если вы хотите просто быстро установить прошивку для вашей Orange Pi 4 (4b), не разбираясь в деталях,
[**тут вы найдёте простые инструкции**](#1-быстрая-установка-прошивки)

Если же вы используете любую другую плату Raspberry Pi, Orange Pi, Banana Pi, Asus Tinker Board или нечто ещё, тогда вы можете скачать нужную версию прошивки (желательно ubuntu или ubuntu based os) с официального сайта производителя платы, произвести настройку видеодрайверов OpenGL (ES) по необходимости и самостоятельно установить все пакеты, [**следуя всем инструкциям этго и последующих разделов**](#2-установка-и-настройка-официальной-прошивки)

Также вы можете расширять набор пакетов, которые вы устанавливаете, на ваше усмотрение. Если вы создадите свой образ или найдёте другой набор пакетов для Kodi, убедительная просьба добавить информацию в обсуждение к этому репозиторию. Главное требование, чтобы вашим решением можно было воспользоваться свободно и бесплатно, как завещал Ричард Столлман.

# **ОГЛАВЛЕНИЕ**

[**1 Быстрая установка прошивки для тех, кто хочет "ctrl+c ctrl+v"**](#1-быстрая-установка-прошивки)

[**2 Установка и настройка официальной прошивки**](#2-установка-и-настройка-официальной-прошивки)

[**3 Настройка дров для gpu Mali-T860 MP4 в образе Orange Pi 4**](#3-настройка-дров-для-gpu-Mali-T860-mp4-в-образе-orange-pi-4)

[**4 Установка и настройка Kodi с плагинами**](#4-установка-и-настройка-kodi-с-плагинами)

[**5 Общее описание фишек прошивки и подведение итогов**](#5-общее-описание-фишек-прошивки-и-подведение-итогов)



# 1 Быстрая установка прошивки

Для начала вам потребуется, неожиданно, Micro SD карта. Скорость class 10 не просто так рекомендуется даже для обычных дистрибутивов, ведь с sd карты происходит загрузка системы. В случае с использованием Kodi фильмы будут временно чуть ли не полностью загружаться на эту sd карту для просмотра, поэтому хорошая надёжная sd-карта обязательна для комфортного просмотра видео без тормозов. Рекомендую брать Kingston или Samsung, проживут на порядок дольше, чем карты других компаний, а также проверены временем. 

Что же касается размера sd карты, то просто для системы должно хватить и 8-гигабайт, однако для того, чтобы было удобно смотреть фильмы в full HD, рекомендую 32 гигабайта. Orange Pi всё равно не тянет 4к видео в 30 fps, мощностей процессора не хватает, а при незначительном перегреве он начинает люто и истерично троттлить, не выходя их этого состояния до полного остывания.

Далее карту необходимо форматировать. Если вы знаете хотя бы 2 таблицы разделов (GPT и MBR), то рекомендую MBR - дефолт для винды. Что же касается файловой системы - в сети рекомендуют fat32. 

Форматирование и подготовку SD карты рекомендую проводить в программе: [SDCardFormatterv5_WinEN.zip](https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/raw/firmware/tools/SDCardFormatterv5_WinEN.zip)

После чего можно залить готовый образ: [ubuntu_18.04_kodi_orange_pi_4_full.tar.xz](https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/releases/download/v1.0.0/ubuntu_18.04_kodi_orange_pi_4_full.tar.xz)

Сначала нужно распаковать ubuntu_18.04_kodi_orange_pi_4_full.img, например, через WinRAR или 7zip.

Заливать образ на sd карту можно с помощью программы: [win32diskimager-1.0.0-install.exe](https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/raw/firmware/tools/win32diskimager-1.0.0-install.exe) 

После заливки образа загружаемся с него, для этого просто вставляем в слот для sd карты на Orange Pi, подключаем монитор и подаём питание. Если получаем зелёный экран или артефакты - выключаем питание и включаем снова, такое иногда случается при первом запуске.

По умолчанию существует учётная запись orangepi с паролем orangepi.

После успешной загрузки (пароль у вас не потребуют) требуется первым делом расширить системный раздел. Для этого запускаем gparted и делаем resize системного раздела так, чтобы он занимал всё оставшееся место на sd карте. 

Система готова к использованию. Предустановлен [**ряд фишек**](#5-общее-описание-фишек-прошивки-и-подведение-итогов) для удобного управления ТВ-приставкой с дивана, используя лишь bluetooth клавиатуру как пульт.



# 2 Установка и настройка официальной прошивки

Если вы используете плату не Orange Pi, тогда скачайте с официального сайта вашу прошивку. Желательно, чтобы она была основана на ubuntu 18.04 или, что лучше, 20.04, так как там доступна новая версия Kodi. Также смотрите, чтобы на этой прошивке работали видеодрайвера. Проверить это можно, установив:

`sudo apt install glmark2 glmark2-es2`

Запускать в консоли с запущенным окружением рабочего стола:

`glmark2` и `glmark2-es2` соответственно.

glmark2 - вряд ли увидит видеокарт и выдаст хороший результат, так как это тест полноценных драйверов OpenGL (На Orange Pi 4 он пытается вызвать rockchip драйвер, которого нет). Важно, чтобы хотя бы glmark2-es2 увидел вашу видеокарту и использовал драйвера OpenGL ES (просто сообщений об ошибках не должно возникнуть). 

Armbian 20.04 для Orange Pi 4 на тот момент, когда я делал эту прошивку, не поддерживал драйвера для видеокарты Mali-T860 MP4, а ubuntu xenial (16.04) и bionic (18.04) из официального репозитория Orange Pi поддерживали.

Скачать последнюю версию ubuntu 18.04 (bionic) для Orange Pi 4 можно на официальном сайте [Orange Pi](http://www.orangepi.org/index.html) в разделе [Downloads](http://www.orangepi.org/downloadresources/).

Или же можете воспользоваться моим клоном [OrangePi_4_ubuntu_bionic_desktop_linux4.4.179_v1.3](https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/tree/firmware/images/OrangePi_4_ubuntu_bionic_desktop_linux4.4.179_v1.3), на основе которого всё было настроено. Сохранил, так как новые официальные обновления могут потребовать изменить процесс установки. 

Образ нужно просто залить на SD карту, для этого сначала форматируем её: [SDCardFormatterv5_WinEN.zip](https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/raw/firmware/tools/SDCardFormatterv5_WinEN.zip)

После чего можно залить образ на SD карту с помощью программы: [win32diskimager-1.0.0-install.exe](https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/raw/firmware/tools/win32diskimager-1.0.0-install.exe)

Для некоторых образов Raspberry Pi у меня система исправно загружалась только при использовании [Etcher](https://www.balena.io/etcher/)

Далее остаётся вставить SD карту в плату, подключить монитор, клавиатуру, мышь, **подключиться к сети** и начать установку ПО.

### **!!! ВАЖНО!!!** 

**Хорошим тоном считается обновить систему через sudo apt update; sudo apt upgrade сразу после установки. В нашем случае это нельзя делать, так как система имеет вручную скомпилированный набор драйверов для видеокарты Mali-T860 MP4, и после обновления они навсегда стираются. Чтобы всё работало правильно, идём чётко по инструкции.**

Обновляем лишь списки репозиториев:

`sudo apt update`

После чего вероятно вылезет ошибка с lock-ами для apt. Но, приняв информацию к сведению, просто нагло удаляем локи, не разбираясь в причинах.

`sudo rm -rf /var/lib/dpkg/lock-frontend`

`sudo rm -rf /var/lib/dpkg/lock`

Повторяем и смотрим, чтобы не вылезло ошибок:

`sudo apt update`

Если вы увидели, 

Чтобы система не требовала пароль при загрузке нашего LXDE, нужно прописать:

`sudo bash -c 'echo "[SeatDefaults]" > /etc/lightdm/lightdm.conf;echo "user-session=ubuntu" >> /etc/lightdm/lightdm.conf;echo "greeter-session=lightdm-gtk-greeter" >> /etc/lightdm/lightdm.conf;echo "autologin-user=orangepi" >> /etc/lightdm/lightdm.conf;echo "autologin-user-timeout=0" >> /etc/lightdm/lightdm.conf'`

Если же вы используете другое окружение рабочего стола, просто отключите требование пароля при входе соответствующем образом. Хотя можете оставить вход в систему запароленным. Если 4-цифры кода родительской защиты любой карапуз взломает, то после взлома пароля учётной записи linux должны брать в любой вуз без вступительных экзаменов. Win-Win.  

Остаётся только поставить несколько стандартных пакетов для упрощения работы:

`sudo apt install -y htop gedit nano gparted exfat-fuse exfat-utils ntfs-3g` 

Если хотите **vim**, а не **nano**, ваше право. exFat и ntfs ставятся, чтобы можно было читать флешки в этих разметках.

Делать **sudo apt upgrade** на Orange Pi 4 нельзя до пункта [**3 Настройка дров для gpu Mali-T860 MP4 в образе Orange Pi 4**](#3-настройка-дров-для-gpu-Mali-T860-mp4-в-образе-orange-pi-4)

Если же вы используете другую плату, и у вас не возникло проблем с дровами, просто обновите систему:

`sudo apt upgrade -y`

Если же проблемы возникнут, придётся начинать сначала и искать причину поломки.

Также рекомендуется произвести:

`sudo reboot`

После обновления системы.



# 3 Настройка дров для gpu Mali-T860 MP4 в образе Orange Pi 4

Сначала нужно запретить обновляться скомпилированным вручную дровам. 

`echo "libegl-mesa0 hold" | sudo dpkg --set-selections` # Убивает GPU драйвер

`echo "libgl1-mesa-dri hold" | sudo dpkg --set-selections` # После обновления замедляет загрузку ОС 

`echo "libllvm9 hold" | sudo dpkg --set-selections` # Зависимость libgl1-mesa-dri

Теперь можно спокойно обновлять систему

`sudo apt update`

`sudo apt upgrade -y`

На все запросы в процессе **apt upgrade** либо вводим "N", либо выбираем пункт "No". После обновления системы производим:

`sudo reboot`



# 4 Установка и настройка Kodi с плагинами

Тут всё просто ставим vlc для кодеков и дров, kodi с зависимостями и с плагинами:

`sudo apt install --install-suggests -y vlc`

`sudo apt install --install-suggests -y kodi`

`sudo apt install -y kodi-pvr*`

Чтобы автоматически загружаться в kodi на LXDE прописываем:

`bash -c 'echo "[Desktop Entry]" > ~/.config/autostart/kodi.desktop;echo "Type=Application" >> ~/.config/autostart/kodi.desktop;echo "Name=Kodi" >> ~/.config/autostart/kodi.desktop;echo "Comment=Kodi" >> ~/.config/autostart/kodi.desktop;echo "Exec=kodi-standalone" >> ~/.config/autostart/kodi.desktop;echo "StartupNotify=false" >> ~/.config/autostart/kodi.desktop;echo "Terminal=false" >> ~/.config/autostart/kodi.desktop;echo "Hidden=false" >> ~/.config/autostart/kodi.desktop;'`

Если же вы используете другое окружение рабочего стола, просто настройке автозапуск **kodi-standalone** (сервис, запускающий и перезапускающий **kodi** при вылетах) соответствующем образом.

Теперь необходимо перезагрузиться:

`sudo reboot`

Если вы загрузились, и запустилась kodi, тогда всё сработало прекрасно. Далее пойдём устанавливать плагины и репозитории. Я использовал эти статьи: 

https://iptvmaster.ru/best-russian-repositories-kodi/

https://ninja-it.ru/nastraivaem-iptv-v-mediapleere-kodi/

Снова открываем терминал, переходим в домашнюю директорию и качаем репозитории (Я просто дублировал информацию у себя в репозитории, чтобы она не потерялась и не исчезла. Можете скачать с сайтов, если они ещё будут работать):

`wget https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/raw/firmware/kodi-repositories/repository.seppius.zip`

`wget https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/raw/firmware/kodi-repositories/repository.search.db-1.1.41.zip`

`wget https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/raw/firmware/kodi-repositories/repository.tdw1980-1.0.2.zip`

`wget https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/raw/firmware/kodi-repositories/repository.srg70-1.1.3.zip`

Также можете скачать xbmc.python-2.26 (оригинал гуглите), он требуется для некоторых плагинов.

`wget https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/raw/firmware/kodi-repositories/xbmc.python-2.26.0.zip`

Теперь по исчерпывающему руководству https://ninja-it.ru/nastraivaem-iptv-v-mediapleere-kodi/ устанавливаем репозитории и настраиваем Puzzle TV. Делаем всё, как в инструкции и, **ВАЖНО**, **не включаем телепрограмму**, так как она способна сломать вообще весь kodi, а перед установкой Puzzle TV желательно исправить один недочёт либы, выполнив команду:

`sudo ln /etc/gdb/gdbinit ~/.gdbinit` # Тогда пакеты ***.db** должны нормально читаться.

В случае, если вы пропустили этот совет, есть такой фикс, который может не сработать, зато всегда можно удалить и заново поставить kodi:

https://forum.tv-mosaic.com/viewtopic.php?t=501

`sudo rm -rf ~/.kodi/userdata/Database/TV*.db ~/.kodi/userdata/Database/Epg*.db`

После чего по руководству https://iptvmaster.ru/best-russian-repositories-kodi/ можно добавить сервисы для просмотра фильмов. Я рекомендую Мосфильм, Kinopoisk-3.0 и RuTor.

**Важно настроить, чтобы кодеком для просмотра торрент-видео всегда был torrent2http (t2http), все другие просто падают с ошибками даже у меня на windows 10**

После чего можно убедиться, что мы ничего не сломали, установить и настроить красивый интерфейс. Я рекомендую **Confluence Extended**. Не только из-за его популярности, но ещё из-за того, что он ставится, не ломая весь kodi. Также вы можете настроить Русский язык интерфейса.



# 5 Общее описание фишек прошивки и подведение итогов

Теперь настало время установить косметические фишки. Ставим систему смены раскладки и Русский язык системы по желанию.

Можно сделать возможность работы исключительно с помощью клавиатуры. Для этого нам нужно установить программу https://linux.die.net/man/1/xbindkeys

`sudo apt install xbindkeys`

Настраиваем там вызов терминала по **ctrl+alt+t**, например. После чего создаём скрипт экстренного закрытия и открытия kodi (из-за либ на питоне, kodi жёстко тупит с этим, поэтому давайте поможем старичку)

`bash -c 'echo "#!/bin/bash" > /usr/bin/kodi-down;echo "killall kodi-standalone" >> /usr/bin/kodi-down;echo "killall kodi" >> /usr/bin/kodi-down;echo "killall kodi.bin" >> /usr/bin/kodi-down;'`

`chmod +x /usr/bin/kodi-down`

`bash -c 'echo "#!/bin/bash" > /usr/bin/kodi-up;echo "/usr/bin/kodi-down" >> /usr/bin/kodi-up;echo "/usr/bin/kodi-standalone &" >> /usr/bin/kodi-up;'`

`chmod +x /usr/bin/kodi-up`

В xbindkeys же настраиваем вызов **kodi-up по ctrl+alt+Up**, а **kodi-down по ctrl+alt+Down**. Теперь мы можем удобно открывать и закрывать kodi.

**Самое главное преимущество такого медиа-центра перед готовыми решениями, вы получаете не только медиа-центр, но и полноценный arm64 компьютер на базе linux.**

И, вишенка на торте, можете установить красивые обои (Делал через printscreen в 1080p. Если хотите большее разрешение, можете сделать сами): 

![img](https://github.com/ITMO-lab/Orange-Pi-4-Kodi-Media-Center/blob/images/Kodi-17.6-Splash-1920x1080.png)